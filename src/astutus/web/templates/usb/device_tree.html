<link rel="stylesheet" href="/static/device_tree.css" />
<p>
  <input type="checkbox" onclick="toggleVisibility(this, '.node_attr_table_class', 'block')">Attribute Table</input>
  <input type="checkbox" onclick="toggleVisibility(this, '.node_id_class', 'inline')">Node ID</input>
  <span>
  <input type="color" value="{{ tree_html_background_color }}" onchange="onBackgroundColorChange(this)" class="astutus-color">Background Color</input>
  </span>
</p>
<div class="tree_html" id="tree-html-container">
  {% if tree_html is not none %}
    {{ tree_html | safe }}
  {% endif %}

  {% if tree_dirpaths is not none %}
    {% for dirpath in tree_dirpaths %}
      <p>{{ dirpath }}</p>
    {% endfor %}
  {% endif %}
  {% if bare_tree is not none %}
    {{ bare_tree | safe }}
  {% endif %}

</div>
  <!-- TODO: Add in collapsing feature without bringing the ugly styling
    <script>
    $(function() {
      $('#tree-html-container').jstree();
    });
  </script> -->
<div id="add-alias-form-container" class="astutus-popup">
  <div class="add-alias-form">
    <form method="POST">
      <table id="astutus-add-alias-table">
      <tr>
        <td><label for="nodepath">Node path:</label></td>
        <td>
          <textarea name="nodepath" id="nodepath" rows="3" cols="50" wrap="soft"></textarea>
        </td>
      </tr>
      <tr>
        <td><label for="template">Template:</label></td>
        <td><input
            name="template"
            id="template"
            type="text"
            value="need to populate ..."
            onselect="console.log('onselect: ' + Date.now())"
            oninput="console.log('oninput: ' + Date.now())"
            onblur="rememberTemplateSelection(this.selectionStart, this.selectionEnd)"
            onchange="console.log('onchange: ' + Date.now())"/></td>
      </tr>
      <tr>
        <td><label for="color">Choose a color:</label></td>
        <td>
          <input name="color" id="color" type="color" class="astutus-color"/>
        </td>
      </tr>
      <tr>
        <td><input name="action" id="action" type="hidden" value="add_or_update_alias" /></td>
      </tr>
      <tr>
        <td><input type="submit" value="Add" id="add_alias_form_add_button" /></td>
        <td><input type="button" value="Cancel" onclick="handleAddAliasFormCancel()"/></td>
      </tr>
      </table>
    </form>
  </div>
  <div id="placeholder-instructions">
    The following placeholders can be inserted into the template by clicking its Insert button.
    <table class="astutus-table-scroll-header">
      <thead><tr><th></th><th>Placeholder</th><th>Current Value</th></tr></thead>
    </table>
  </div>
  <div class="astutus-table-scroll-wrapper">
    <div class="astutus-table-scroll">
      <table id="alias-placeholder-table" class="astutus-table-scroll">
        <tr><td>Placeholder</td><td>Current Value</td><td></td></tr>
      </table>
    </div>
  </div>
</div>
<script src="/static/device_tree.js"></script>
{% if aliases_javascript is not none %}
{{ aliases_javascript | safe }}
{% endif %}
<script>

  function onTreeButtonClick(button) {
    data = {};
    nodedata = JSON.parse(button.dataset['nodedata']);
    Object.assign(data, nodedata);
    dataForDir = JSON.parse(button.dataset['data_for_dir']);
    Object.assign(data, dataForDir);
    data["nodepath"] = button.dataset['nodepath'];
    // Currently button.dataset['info'] uses single quotes, but the JSON parser wants double quotes.
    info = button.dataset['info']
    if (info) {
      info = info.replace("'", '"')
      console.log('info: ', info)
      deviceInfo = JSON.parse()
      Object.assign(data, deviceInfo);
    }
    handleAliasAddForm(button, data);
  }

  function updateNodeData(button, buttonData) {
    // node_data = astutus.usb.tree.get_node_data(data, device_config, alias)
    var dirpath = button.dataset['dirpath'];
    var nodepath = button.dataset['nodepath'];
    var alias = aliases.findLongest(nodepath)
    var span = button.nextElementSibling
    // Start work on using vanilla Javascript to Get using query passed in JSON.
    const xhr = new XMLHttpRequest();
    // listen for `load` event
    xhr.onload = () => {
      // print JSON response
      if (xhr.status >= 200 && xhr.status < 300) {
          // parse JSON
          const response = JSON.parse(xhr.responseText);
          console.log(response);
          span.innerHTML = response["html_label"];
          button.onclick = function(){onTreeButtonClick(button)}
          nodeData = response['node_data'];
          button.dataset['nodedata'] = JSON.stringify(nodeData);
      }
    };
    xhr.open('PUT', '/astutus/usb/label' + dirpath);
    xhr.setRequestHeader('Content-Type', 'application/json');
    data = {
      'data': buttonData,
      'device_config': 'device_config_goes_here',
      'alias': alias,
    }
    xhr.send(JSON.stringify(data));

    // $.ajax('/astutus/usb/node' + dirpath, {
    //   method: 'GET',
    //   data: buttonData,
    //   success: function(data, textStatus,  jqXHR) {
    //     nodeData = data['node_data'];
    //     button.dataset['nodedata'] = JSON.stringify(nodeData);
    //     span.innerHTML = nodeData["html_label"];
    //     button.onclick = function(){onTreeButtonClick(button)}
    //   },
    //   error: function(xhr) {
    //       throw new Error("updateNodeData failed.")
    //   }
    // });
  }

  function updateButtonData(button) {
    var dirpath = button.dataset['dirpath'];
    console.log("dirpath: ", dirpath)
    var deviceInfo = button.dataset['info'];
    if (deviceInfo == undefined) {
      deviceInfo = "Nothing!"
    }
    data = {
      'info': deviceInfo,
    };
    $.ajax('/astutus/usb' + dirpath, {
      method: 'PATCH',
      data: data,
      success: function(data, textStatus,  jqXHR) {
        buttonData = data['data_for_dir'];
        button.dataset['data_for_dir'] = JSON.stringify(buttonData);
        nodeId = buttonData['node_id'];
        parentDirpath = buttonData["parent_dirpath"];
        if (parentDirpath in  nodePathByDirPath) {
          parentNodePath = nodePathByDirPath[parentDirpath];
          nodePath = parentNodePath + "/" + nodeId;
        } else {
          nodePath = nodeId;
        }
        nodePathByDirPath[buttonData["dirpath"]] = nodePath;
        button.dataset['nodepath'] = nodePath;

        updateNodeData(button, buttonData);
        buttonIdx++;
        updateDescription(buttonIdx);
      },
      error: function(xhr) {
          alert('Failed')
      }
    });
  }

  function updateDescription(buttonIdx) {
    // Start with the first button, and eventually process all buttons asynchronously.
    updateButtonData(buttons[buttonIdx])
  }

  var nodePathByDirPath = {}
  var buttons;
  var buttonIdx;
  function updateAllDescriptions() {
    buttons = document.querySelectorAll("button.astutus-tree-item-button");
    buttonIdx = 1
    updateDescription(buttonIdx);
  }

  // Set the background color upon loading
  $(".tree_html").css("background-color", '{{ tree_html_background_color }}');
  updateAllDescriptions();

</script>
